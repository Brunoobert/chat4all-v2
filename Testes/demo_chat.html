<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat4All - Real Time Demo</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; display: flex; gap: 20px; }
        .config { width: 30%; padding: 20px; background: #f3f4f6; border-radius: 8px; }
        .chat-area { width: 70%; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column; height: 500px; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .input-area { padding: 20px; background: #f9fafb; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        input { width: 100%; }
        button { background: #10b981; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:disabled { background: #9ca3af; }
        
        .msg { padding: 10px; margin-bottom: 10px; border-radius: 8px; max-width: 80%; }
        .msg.sent { background: #d1fae5; margin-left: auto; text-align: right; } /* Verde (Enviada) */
        .msg.received { background: #e5e7eb; margin-right: auto; } /* Cinza (Recebida via WS) */
        .meta { font-size: 0.75em; color: #6b7280; margin-top: 4px; }
    </style>
</head>
<body>

    <div class="config">
        <h3>ðŸ”Œ ConexÃ£o</h3>
        <label>Token (Bearer):</label>
        <input type="text" id="token" placeholder="Cole seu token admin...">
        <button onclick="connectWS()" id="btnConnect" style="margin-top: 10px; width: 100%;">Conectar WebSocket</button>
        <p id="status" style="color: red;">Desconectado</p>

        <hr>
        
        <h3>ðŸ†” Contexto</h3>
        <label>ID da Conversa (UUID):</label>
        <input type="text" id="chatId" placeholder="ID do Grupo criado...">
    </div>

    <div class="chat-area">
        <div class="messages" id="messageBox">
            <div style="text-align: center; color: #aaa; margin-top: 20px;">
                Conecte para ver mensagens em tempo real...
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Digite uma mensagem...">
            <button onclick="sendMessage()" id="btnSend" disabled>Enviar</button>
        </div>
    </div>

<script>
    let ws;
    const API_URL = "http://localhost:8000/v1";
    const WS_URL = "ws://localhost:8000/ws";

    function logMsg(text, type, sender) {
        const box = document.getElementById("messageBox");
        const div = document.createElement("div");
        div.className = `msg ${type}`;
        div.innerHTML = `
            <strong>${sender}</strong><br>${text}
            <div class="meta">${new Date().toLocaleTimeString()}</div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function connectWS() {
        const token = document.getElementById("token").value;
        if (!token) return alert("Precisa do Token!");

        // Conecta no WebSocket passando o Token na URL
        ws = new WebSocket(`${WS_URL}?token=${token}`);

        ws.onopen = () => {
            document.getElementById("status").innerText = "ðŸŸ¢ Conectado e Ouvindo...";
            document.getElementById("status").style.color = "green";
            document.getElementById("btnConnect").disabled = true;
            document.getElementById("btnSend").disabled = false;
            document.getElementById("messageBox").innerHTML = ""; // Limpa tela
        };

        ws.onmessage = (event) => {
            // AQUI Ã‰ A MÃGICA: O servidor mandou msg via WebSocket!
            const data = JSON.parse(event.data);
            console.log("Recebido via WS:", data);
            
            // Renderiza na tela como "Recebida"
            logMsg(data.content, "received", data.sender_id);
        };

        ws.onclose = () => {
            document.getElementById("status").innerText = "ðŸ”´ Desconectado";
            document.getElementById("status").style.color = "red";
            document.getElementById("btnConnect").disabled = false;
        };
    }

    async function sendMessage() {
        const token = document.getElementById("token").value;
        const chatId = document.getElementById("chatId").value;
        const content = document.getElementById("msgInput").value;

        if (!chatId || !content) return alert("Preencha ID do Chat e Mensagem");

        // Envia via REST API (Backend processa -> Kafka -> Worker -> Redis -> WS)
        try {
            const res = await fetch(`${API_URL}/messages`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    content: content,
                    channels: ["all"]
                })
            });

            if (res.ok) {
                document.getElementById("msgInput").value = "";
                // NÃ£o logamos manualmente aqui! 
                // Esperamos o WebSocket devolver a mensagem para provar que o ciclo funcionou.
            } else {
                alert("Erro ao enviar: " + res.status);
            }
        } catch (e) {
            alert("Erro API: " + e);
        }
    }
</script>

</body>
</html>